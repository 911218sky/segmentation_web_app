# 血管量測系統演算法技術文件

## 目錄
1. [系統概述](#1-系統概述)
2. [系統架構流程圖](#2-系統架構流程圖)
3. [影像前處理](#3-影像前處理)
4. [深度學習分割模型](#4-深度學習分割模型)
5. [血管邊界線提取演算法](#5-血管邊界線提取演算法)
6. [時序穩定性濾波器](#6-時序穩定性濾波器)
7. [視覺化與量測輸出](#7-視覺化與量測輸出)
8. [影片處理流程](#8-影片處理流程)

---

## 1. 系統概述

本系統為一套基於深度學習的血管自動量測工具，專門用於超音波影像中血管直徑的自動檢測與量測。系統整合了 **YOLOv13 實例分割模型**、**梯度分析邊界偵測**以及**魯棒時序濾波**等技術，實現高精度、即時的血管尺寸量測。

### 1.1 核心技術特點

| 技術模組 | 演算法/方法 | 說明 |
|---------|------------|------|
| 物件偵測與分割 | YOLOv13 Instance Segmentation | 即時血管區域分割 |
| 影像增強 | CLAHE (對比度限制自適應直方圖均衡化) | 增強血管邊界對比度 |
| 邊界偵測 | Sobel 梯度運算 | 精確定位血管壁位置 |
| 異常值過濾 | 魯棒 Z-score + MAD | 移除量測異常值 |
| 時序平滑 | 滑動視窗中位數濾波 | 確保量測穩定性 |

---

## 2. 系統架構流程圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           輸入：超音波影像/影片                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    步驟 1：影像前處理 (Preprocessing)                         │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │  等比縮放        │ -> │  Letterbox      │ -> │  GPU 加速處理   │         │
│  │  (Uniform Scale) │    │  (黑邊填充)      │    │  (PyTorch)     │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    步驟 2：YOLOv13 實例分割推論                               │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │  特徵提取        │ -> │  物件偵測       │ -> │  分割遮罩生成    │         │
│  │  (Backbone)     │    │  (Detection)    │    │  (Mask Head)    │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    步驟 3：血管邊界線提取                                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │  CLAHE 增強     │ -> │  Sobel 梯度計算 │ -> │  邊界點定位      │         │
│  │  (對比度增強)    │    │  (∂I/∂y)       │    │  (Top/Bottom)   │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    步驟 4：移動平均平滑過濾                                    │
│  ┌─────────────────┐    ┌─────────────────┐                               │
│  │  滑動視窗平滑    │ -> │  異常線段移除   │                               │
│  │  (Moving Avg)   │    │  (Threshold)    │                               │
│  └─────────────────┘    └─────────────────┘                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    步驟 5：時序穩定性濾波 (影片模式)                           │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │  Welford 暖身   │ -> │  魯棒 Z-score   │ -> │  ROC 變化率檢測  │         │
│  │  (基線建立)      │    │  (MAD 計算)     │    │  (相鄰幀比對)    │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    輸出：量測結果與視覺化                                     │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
│  │  血管直徑 (mm)   │    │  統計數據       │    │  可視化影像      │         │
│  │  Mean/Max/Min   │    │  Excel 報表     │    │  標註影片        │         │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘         │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 影像前處理

### 3.1 等比縮放與 Letterbox 填充

為確保輸入模型的影像尺寸一致，同時保持原始長寬比，系統採用 **Letterbox** 技術進行影像前處理。

#### 演算法步驟：

**步驟 1：計算縮放比例**

$$
\text{scale} = \min\left(\frac{W_{target}}{W_{src}}, \frac{H_{target}}{H_{src}}\right)
$$

其中：
- $W_{target}, H_{target}$：目標尺寸（預設 1024×1024）
- $W_{src}, H_{src}$：原始影像尺寸

**步驟 2：計算新尺寸**

$$
W_{new} = \text{round}(W_{src} \times \text{scale})
$$

$$
H_{new} = \text{round}(H_{src} \times \text{scale})
$$

**步驟 3：計算填充量**

$$
\text{pad}_{left} = \left\lfloor \frac{W_{target} - W_{new}}{2} \right\rfloor
$$

$$
\text{pad}_{top} = \left\lfloor \frac{H_{target} - H_{new}}{2} \right\rfloor
$$

**步驟 4：雙線性插值縮放**

使用 PyTorch 的 `F.interpolate` 函數進行 GPU 加速的雙線性插值：

$$
I_{resized}(x', y') = \sum_{i,j} I_{src}(x_i, y_j) \cdot w_{ij}
$$

其中 $w_{ij}$ 為雙線性插值權重。

### 3.2 GPU 加速實現

系統利用 PyTorch 進行 GPU 加速處理，關鍵步驟包括：

```python
# 使用 pin_memory 加速 CPU→GPU 資料傳輸
tensor = tensor.pin_memory().to(device, non_blocking=True)

# 使用 inference_mode 減少記憶體開銷
with torch.inference_mode():
    resized = F.interpolate(tensor, size=(nh, nw), mode="bilinear")
```

---

## 4. 深度學習分割模型

### 4.1 YOLOv13 實例分割架構

本系統採用 **YOLOv13** 作為核心的血管分割模型，其為 YOLO (You Only Look Once) 系列的最新版本，專門針對實例分割任務進行優化。

#### 模型架構：

```
輸入影像 (1024×1024×3)
         │
         ▼
┌─────────────────────┐
│    Backbone         │  ← CSPDarknet / EfficientNet 變體
│  (特徵提取網路)      │
└─────────────────────┘
         │
         ▼
┌─────────────────────┐
│    Neck (FPN+PAN)   │  ← 多尺度特徵融合
│  (特徵金字塔網路)    │
└─────────────────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌───────┐ ┌───────────┐
│ Head  │ │ Mask Head │
│(偵測) │ │ (分割)    │
└───────┘ └───────────┘
    │         │
    ▼         ▼
 Boxes     Masks
(邊界框)   (分割遮罩)
```

### 4.2 推論設定參數

| 參數名稱 | 預設值 | 說明 |
|---------|--------|------|
| `imgsz` | 640 | 模型輸入影像尺寸 |
| `conf` | 0.4 | 信心度閾值 |
| `iou` | 0.1 | NMS 的 IoU 閾值 |
| `batch` | 96 | 批次處理大小 |
| `half` | True | FP16 半精度推論 |
| `retina_masks` | True | 高解析度遮罩輸出 |

### 4.3 最高信心度分割選取

當單張影像偵測到多個血管區域時，系統自動選取信心度最高的分割結果：

$$
\text{mask}^* = \text{mask}_{k^*}, \quad k^* = \arg\max_k \text{conf}_k
$$

---

## 5. 血管邊界線提取演算法

### 5.1 演算法概述

血管邊界線提取是系統的核心量測模組，透過分析分割遮罩與原始影像的灰階梯度，精確定位血管壁的上下邊界位置。

### 5.2 CLAHE 對比度增強

**CLAHE (Contrast Limited Adaptive Histogram Equalization)** 用於增強血管邊界的對比度：

$$
T(r_k) = \text{round}\left((L-1) \cdot \sum_{j=0}^{k} p_r(r_j)\right)
$$

其中：
- $L$：灰階級數（256）
- $p_r(r_j)$：灰階值 $r_j$ 的機率密度
- 對比度限制 (clipLimit) = 4.0
- 網格大小 (tileGridSize) = 16×16

### 5.3 Sobel 垂直梯度計算

使用 **Sobel 運算子**計算影像的垂直方向梯度：

$$
G_y = \begin{bmatrix} -1 & -2 & -1 \\ 0 & 0 & 0 \\ +1 & +2 & +1 \end{bmatrix} * I
$$

取絕對值以獲得梯度強度：

$$
|G_y| = \left|\frac{\partial I}{\partial y}\right|
$$

### 5.4 邊界點定位演算法

#### 步驟 1：粗略邊界搜尋

對於每個採樣的 x 座標位置，從分割遮罩中找出初始的上下邊界：

$$
y_{top}^{(0)}(x) = \min\{y : \text{mask}(x, y) = 1\}
$$

$$
y_{bottom}^{(0)}(x) = \max\{y : \text{mask}(x, y) = 1\}
$$

#### 步驟 2：梯度精修

在粗略邊界附近搜尋梯度最大值位置，使邊界貼合血管壁：

**上邊界精修：**

$$
y_{top}(x) = \arg\max_{y \in [y_{top}^{(0)}, y_{top}^{(0)} + \delta_{top}]} |G_y(x, y)|
$$

**下邊界精修：**

$$
y_{bottom}(x) = \arg\max_{y \in [y_{bottom}^{(0)} - \delta_{bottom}, y_{bottom}^{(0)}]} |G_y(x, y)|
$$

其中 $\delta_{top}$ 和 $\delta_{bottom}$ 為搜尋範圍參數（預設值：5 像素）。

### 5.5 移動平均平滑過濾

為移除因雜訊或分割誤差產生的異常量測線，系統採用滑動視窗移動平均進行平滑過濾。

#### 計算方法：

**步驟 1：計算每條線的高度**

$$
h_i = |y_{bottom,i} - y_{top,i}|
$$

**步驟 2：使用前綴和計算移動平均**

$$
\text{MA}_i = \frac{1}{w} \sum_{j=i-\lfloor w/2 \rfloor}^{i+\lceil w/2 \rceil - 1} h_j
$$

其中 $w$ 為視窗大小（預設值：5）。

**步驟 3：計算相對差異並過濾**

$$
\text{rel\_diff}_i = \frac{|h_i - \text{MA}_i|}{\max(\text{MA}_i, \epsilon)}
$$

保留條件：

$$
\text{keep}_i = (\text{rel\_diff}_i \leq \theta)
$$

其中 $\theta$ 為閾值（預設值：0.1）。

### 5.6 參數配置

| 參數 | 預設值 | 說明 |
|-----|--------|------|
| `sample_interval` | 5 | x 軸採樣間隔（像素）|
| `gradient_search_top` | 5 | 上邊界梯度搜尋範圍 |
| `gradient_search_bottom` | 5 | 下邊界梯度搜尋範圍 |
| `keep_ratio` | 0.3 | 中央區域保留比例 |
| `window_size` | 5 | 平滑視窗大小 |
| `threshold` | 0.1 | 過濾閾值 |

---

## 6. 時序穩定性濾波器

### 6.1 設計目標

在影片處理模式下，為確保跨幀量測結果的穩定性與可靠性，系統實作了一套**魯棒時序穩定性濾波器**，用於：

1. 建立穩定的量測基線
2. 偵測並濾除異常值
3. 限制相鄰幀間的變化率

### 6.2 暖身階段：Welford 線上演算法

系統使用 **Welford 演算法**以 O(1) 複雜度累積計算均值與變異數：

**更新公式：**

$$
n \leftarrow n + 1
$$

$$
\delta = x_n - \bar{x}_{n-1}
$$

$$
\bar{x}_n = \bar{x}_{n-1} + \frac{\delta}{n}
$$

$$
M_{2,n} = M_{2,n-1} + \delta \cdot (x_n - \bar{x}_n)
$$

**變異數計算：**

$$
\sigma^2 = \frac{M_2}{n-1}
$$

### 6.3 基線建立條件

當暖身期（預設 10 幀）結束後，若變異係數 (CV) 低於閾值，則建立基線：

$$
\text{CV} = \frac{\sigma}{\bar{x}} \leq \text{CV}_{max}
$$

預設 $\text{CV}_{max} = 0.08$（8%）。

### 6.4 魯棒 Z-score 異常偵測

使用中位數 (Median) 與中位數絕對偏差 (MAD) 取代傳統的均值與標準差，提供更魯棒的異常偵測：

**中位數計算：**

$$
\text{median} = \begin{cases} x_{(n+1)/2} & \text{if } n \text{ is odd} \\ \frac{x_{n/2} + x_{n/2+1}}{2} & \text{if } n \text{ is even} \end{cases}
$$

**MAD (Median Absolute Deviation)：**

$$
\text{MAD} = \text{median}(|x_i - \text{median}(x)|)
$$

**魯棒標準差估計：**

$$
\hat{\sigma} = 1.4826 \times \text{MAD}
$$

（常數 1.4826 使 MAD 在常態分佈下等價於標準差）

**魯棒 Z-score：**

$$
z = \frac{|x - \text{median}|}{\hat{\sigma}}
$$

**異常判定條件：**

$$
\text{anomaly} = (z > z_{thresh})
$$

預設 $z_{thresh} = 3.5$。

### 6.5 相對基線容忍範圍

一旦基線建立，新的量測值必須落在基線的容許範圍內：

$$
\text{valid} = \left( \text{baseline} \times (1 - \tau) \leq x \leq \text{baseline} \times (1 + \tau) \right)
$$

預設 $\tau = 0.2$（±20%）。

### 6.6 變化率 (ROC) 限制

限制相鄰兩幀之間的量測變化量：

$$
|\Delta x| = |x_t - x_{t-1}| \leq \text{ROC}_{max}
$$

預設 $\text{ROC}_{max} = 3.0$ mm/幀。

### 6.7 濾波器參數總覽

| 參數 | 預設值 | 說明 |
|-----|--------|------|
| `init_window` | 10 | 暖身期幀數 |
| `init_cv_max` | 0.08 | 暖身期 CV 上限 |
| `win_size` | 9 | 滑動視窗大小 |
| `z_thresh` | 3.5 | 魯棒 z-score 門檻 |
| `rel_tol` | 0.2 | 相對基線容忍範圍 |
| `roc_abs_max` | 3.0 | 相鄰幀最大變化量 (mm) |

### 6.8 演算法流程圖

```
              輸入新的量測值 x_t
                      │
                      ▼
            ┌─────────────────┐
            │ 基線是否已建立？ │
            └────────┬────────┘
                     │
         ┌───────────┴───────────┐
         │ No                    │ Yes
         ▼                       ▼
   ┌────────────┐      ┌────────────────┐
   │ Welford    │      │ 計算滑動視窗   │
   │ 累積更新    │      │ 中位數與 MAD   │
   └─────┬──────┘      └───────┬────────┘
         │                     │
         ▼                     ▼
   ┌────────────┐      ┌────────────────┐
   │ 檢查 CV    │      │ 計算魯棒 z-score│
   │ 是否達標   │      │ z > threshold? │
   └─────┬──────┘      └───────┬────────┘
         │                     │
         │                     ▼
         │             ┌────────────────┐
         │             │ 檢查基線範圍   │
         │             │ 與 ROC 限制    │
         │             └───────┬────────┘
         │                     │
         ▼                     ▼
   ┌────────────┐      ┌────────────────┐
   │ 建立基線   │      │ 接受/拒絕量測值│
   └────────────┘      └────────────────┘
```

---

## 7. 視覺化與量測輸出

### 7.1 血管直徑計算

對於每條垂直量測線，血管直徑（mm）計算如下：

$$
d_i = |y_{bottom,i} - y_{top,i}| \times \text{pixel\_size\_mm}
$$

其中 `pixel_size_mm` 為超音波影像的像素尺寸（mm/pixel）。

### 7.2 統計指標

系統輸出以下統計指標：

| 指標 | 公式 | 說明 |
|-----|------|------|
| 平均直徑 | $\bar{d} = \frac{1}{n}\sum_{i=1}^{n} d_i$ | 所有量測線的平均值 |
| 標準差 | $\sigma_d = \sqrt{\frac{1}{n-1}\sum_{i=1}^{n}(d_i - \bar{d})^2}$ | 量測的離散程度 |
| 最大直徑 | $d_{max} = \max(d_i)$ | 最大量測值 |
| 最小直徑 | $d_{min} = \min(d_i)$ | 最小量測值 |

### 7.3 視覺化呈現

系統使用半透明疊加方式呈現量測結果：

$$
I_{output} = (1 - \alpha) \cdot I_{original} + \alpha \cdot I_{overlay}
$$

其中 $\alpha$ 為透明度參數（預設 0.7）。

---

## 8. 影片處理流程

### 8.1 幀率抽樣策略

為平衡處理效率與量測精度，系統根據目標幀率進行智慧抽樣：

$$
\text{ratio} = \frac{\text{FPS}_{source}}{\text{FPS}_{target}}
$$

當 $\text{ratio} > 1.05$ 時，抽樣幀索引計算：

$$
\text{frame\_idx}_i = \text{round}(\text{start} + i \times \text{ratio}), \quad i = 0, 1, ..., n-1
$$

其中：

$$
n = \left\lfloor \frac{\text{end} - \text{start} + 1}{\text{ratio}} \right\rfloor
$$

### 8.2 批次處理流程

```
影片輸入
    │
    ▼
┌────────────────────┐
│ 幀率抽樣           │
│ (目標 FPS 選取)    │
└─────────┬──────────┘
          │
          ▼
┌────────────────────┐
│ 批次累積           │
│ (Batch Size = 96)  │
└─────────┬──────────┘
          │
          ▼
┌────────────────────┐
│ GPU Letterbox 縮放 │
│ (批次處理)          │
└─────────┬──────────┘
          │
          ▼
┌────────────────────┐
│ YOLOv13 批次推論   │
│ (分割遮罩生成)      │
└─────────┬──────────┘
          │
          ▼
┌────────────────────┐
│ 逐幀後處理         │
│ (邊界線提取+濾波)   │
└─────────┬──────────┘
          │
          ▼
┌────────────────────┐
│ FFmpeg 影片編碼    │
│ (視覺化輸出)        │
└─────────┬──────────┘
          │
          ▼
輸出影片 + 統計報表
```

### 8.3 區間統計輸出

對於每個時間區間，系統輸出以下統計：

| 欄位 | 說明 |
|-----|------|
| `start_s` | 區間起始時間（秒）|
| `end_s` | 區間結束時間（秒）|
| `frame_count` | 處理的幀數 |
| `mean_of_means_mm` | 逐幀平均值的平均（mm）|
| `max_of_means_mm` | 逐幀平均值的最大（mm）|
| `max_at_s` | 最大值對應的時間點（秒）|

---

## 附錄 A：數學符號表

| 符號 | 說明 |
|-----|------|
| $I$ | 輸入影像 |
| $G_y$ | 垂直方向梯度 |
| $\text{mask}$ | 分割遮罩 |
| $x, y$ | 像素座標 |
| $d$ | 血管直徑 |
| $\bar{x}$ | 均值 |
| $\sigma$ | 標準差 |
| $\text{CV}$ | 變異係數 |
| $\text{MAD}$ | 中位數絕對偏差 |
| $z$ | Z-score |

---

## 附錄 B：參考文獻格式建議

若於學術論文中引用本系統，建議描述方式：

> 本研究使用基於 YOLOv13 深度學習模型的血管自動量測系統，該系統整合對比度限制自適應直方圖均衡化 (CLAHE) 進行影像增強，並使用 Sobel 梯度運算精確定位血管壁邊界。針對影片處理，系統採用魯棒時序穩定性濾波器，結合中位數絕對偏差 (MAD) 與魯棒 Z-score 進行異常值偵測與移除。

---

*文件版本：v1.0*  
*最後更新：2025年11月*

